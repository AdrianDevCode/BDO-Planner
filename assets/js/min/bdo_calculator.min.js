/*
* @Author: SirMrE
* @http: http://www.sirmre.com/bdo-calculator
* @Copyright: (c) 2016 Mark Eliasen
* @license: May be freely distributed under the CC BY-NC 3.0 License 
*           (https://creativecommons.org/licenses/by-nc/3.0/)
* @Date:   2016-04-08 23:52:45
* @Last Modified by:   SirMrE
* @Last Modified time: 2016-04-11 23:38:50
*/
var BDOcalculator={gear:{},sets:{},stats:null,init:function(){this.gear={"main-weapon":{enhancement:0,item_name:"",item:{}},"secondary-weapon":{enhancement:0,item_name:"",item:{}},helmet:{enhancement:0,item_name:"",item:{}},armor:{enhancement:0,item_name:"",item:{}},gloves:{enhancement:0,item_name:"",item:{}},shoes:{enhancement:0,item_name:"",item:{}},rings:{1:{enhancement:0,item_name:"",item:{}},2:{enhancement:0,item_name:"",item:{}}},earrings:{1:{enhancement:0,item_name:"",item:{}},2:{enhancement:0,item_name:"",item:{}}},necklace:{enhancement:0,item_name:"",item:{}},belt:{enhancement:0,item_name:"",item:{}}},this.reset()},setGear:function(t,e,a,i,n){n="function"==typeof n?n:function(){},"undefined"==typeof t&&(t={}),-1!==$.inArray(e,["ring","earring"])?(this.gear[e+"s"][a].item=t,this.gear[e+"s"][a].item_name=i):"undefined"!=typeof this.gear[e].item&&(this.gear[e].item=t,this.gear[e].item_name=i),n()},setEnchantmentLevel:function(t,e,a,i){i="function"==typeof i?i:function(){},-1!==$.inArray(t,["ring","earring"])?this.gear[t+"s"][e].enhancement=String(a):this.gear[t].enhancement=String(a),i()},reset:function(){this.stats=$.extend(!0,{},BDOdatabase.stats),this.sets={}},addStat:function(t,e){if(t in this.stats){if("special"===t)return void this.stats.special.specials.push(e);"ap"===t?(e=parseInt(e)===e?[e,e]:e.split("-"),this.stats[t].min+=parseInt(e[0]),this.stats[t].max+=parseInt(e[1])):this.stats[t].total+=e}},calculateSetEffects:function(){if(0!==Object.keys(this.sets).length)for(var t in this.sets)if(this.sets.hasOwnProperty(t)&&"undefined"!=typeof BDOdatabase.set_effects[t]){var e=BDOdatabase.set_effects[t],a=this.sets[t].length;for(var i in e.pieces)if(e.pieces.hasOwnProperty(i)){var n=e.pieces[i];if(i=parseInt(i),a>=i)for(var s in n)n.hasOwnProperty(s)&&this.addStat(s,n[s])}for(var r in e.combos)if(e.combos.hasOwnProperty(r)){for(var n=e.combos[r].effects,h=!0,m=e.combos[r].pieces,f=m.length-1;f>=0;f--)if(-1===$.inArray(m[f],this.sets[t])){h=!1;break}if(h)for(var s in n)n.hasOwnProperty(s)&&this.addStat(s,n[s])}}},addToSets:function(t,e){"undefined"==typeof this.sets[t]&&(this.sets[t]=[]),this.sets[t].push(e)},getItemStat:function(t,e,a,i){var a="undefined"==typeof a?!1:a,n=a?t.item_effects[e]:t[e];return"0"!==String(i)&&"undefined"!=typeof t.enhancement[String(i)][e]&&(n=t.enhancement[String(i)][e]),n},getGearStat:function(t,e,a){var a="undefined"==typeof a?!1:!0,i=a?t.item.item_effects[e]:t.item[e];return"0"!==String(t.enhancement)&&"undefined"!=typeof t.item.enhancement[String(t.enhancement)][e]&&(i=t.item.enhancement[String(t.enhancement)][e]),i},calculate:function(){$("#stats").html(""),this.reset();for(var t in this.gear)if(this.gear.hasOwnProperty(t))if(-1!==$.inArray(t,["rings","earrings"])){for(var e in this.gear[t])if(this.gear[t].hasOwnProperty(e)){var a=this.gear[t][e];if(0!==Object.keys(a.item).length){for(var i in a.item)a.item.hasOwnProperty(i)&&this.addStat(i,this.getGearStat(a,i));for(var n in a.item.item_effects)a.item.item_effects.hasOwnProperty(n)&&this.addStat(n,this.getGearStat(a,n,!0))}}}else if(Object.keys(this.gear[t].item).length>0){for(var s in this.gear[t].item)if(this.gear[t].item.hasOwnProperty(s)){var r=this.gear[t].item;this.addStat(s,this.getGearStat(this.gear[t],s))}for(var n in this.gear[t].item.item_effects)this.gear[t].item.item_effects.hasOwnProperty(n)&&this.addStat(n,this.getGearStat(this.gear[t],n,!0));switch(this.addToSets(this.gear[t].item.set,t),t){case"main-weapon":case"secondary-weapon":this.addStat("ap",this.getGearStat(this.gear[t],"ap_min")+"-"+this.getGearStat(this.gear[t],"ap_max"))}}this.calculateSetEffects();for(var h in this.stats)if(this.stats.hasOwnProperty(h)){var m=this.stats[h];switch(h){case"special":$("#stats").append("<li><strong>"+m.title+":</strong></li>");for(var f=m.specials.length-1;f>=0;f--)$("#stats").append("<li>"+m.specials[f]+"</li>");break;case"ap":$(".stat-ap span").text(m.min+" ~ "+m.max);break;case"dp":$(".stat-dp span").text(m.total);break;default:$("#stats").append("<li><strong>"+m.title+":</strong> "+("ap"===h?m.min+" ~ "+m.max:m.total)+m.symbol+"</li>")}}}};