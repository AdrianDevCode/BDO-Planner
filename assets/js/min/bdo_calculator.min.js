/*
* @Author: SirMrE
* @http: http://www.sirmre.com/bdo-calculator
* @Copyright: (c) 2016 Mark Eliasen
* @license: May be freely distributed under the CC BY-NC 3.0 License 
*           (https://creativecommons.org/licenses/by-nc/3.0/)
* @Date:   2016-04-08 23:52:45
* @Last Modified by:   SirMrE
* @Last Modified time: 2016-04-10 11:22:24
*/
var BDOcalculator={gear:{},sets:{},stats:null,init:function(){this.gear={"main-weapon":{enhancement:0,item:{}},"secondary-weapon":{enhancement:0,item:{}},helmet:{enhancement:0,item:{}},armor:{enhancement:0,item:{}},gloves:{enhancement:0,item:{}},shoes:{enhancement:0,item:{}},rings:{1:{enhancement:0,item:{}},2:{enhancement:0,item:{}}},earrings:{1:{enhancement:0,item:{}},2:{enhancement:0,item:{}}},necklace:{enhancement:0,item:{}},belt:{enhancement:0,item:{}}},this.reset()},setGear:function(t,e,s,i,a){a="function"==typeof a?a:function(){},"undefined"==typeof t&&(t={}),-1!==$.inArray(e,["rings","earrings"])?this.gear[e][s].item=t:"undefined"!=typeof this.gear[e].item&&(this.gear[e].item=t),a()},setEnchantmentLevel:function(t,e,s,i){i="function"==typeof i?i:function(){},-1!==$.inArray(t,["rings","earrings"])?this.gear[t][e].enhancement=String(s):this.gear[t].enhancement=String(s),i()},reset:function(){this.stats=$.extend(!0,{},BDOdatabase.stats),this.sets={}},addStat:function(t,e){if(t in this.stats){if("special"===t)return void this.stats.special.specials.push(e);"ap"===t?(e=parseInt(e)===e?[e,e]:e.split("-"),this.stats[t].min+=parseInt(e[0]),this.stats[t].max+=parseInt(e[1])):this.stats[t].total+=e}},calculateSetEffects:function(){if(0!==Object.keys(this.sets).length)for(var t in this.sets)if(this.sets.hasOwnProperty(t)&&"undefined"!=typeof BDOdatabase.set_effects[t]){var e=BDOdatabase.set_effects[t],s=this.sets[t].length;for(var i in e.pieces)if(e.pieces.hasOwnProperty(i)){var a=e.pieces[i];if(i=parseInt(i),s>=i)for(var n in a)a.hasOwnProperty(n)&&this.addStat(n,a[n])}for(var r in e.combos)if(e.combos.hasOwnProperty(r)){for(var a=e.combos[r].effects,h=!0,m=e.combos[r].pieces,f=m.length-1;f>=0;f--)if(-1===$.inArray(m[f],this.sets[t])){h=!1;break}if(h)for(var n in a)a.hasOwnProperty(n)&&this.addStat(n,a[n])}}},addToSets:function(t,e){"undefined"==typeof this.sets[t]&&(this.sets[t]=[]),this.sets[t].push(e)},getItemStat:function(t,e,s){var s="undefined"==typeof s?!1:!0,i=s?t.item.item_effects[e]:t.item[e];return"0"!==String(t.enhancement)&&"undefined"!=typeof t.item.enhancement[String(t.enhancement)][e]&&(i=t.item.enhancement[String(t.enhancement)][e]),i},calculate:function(){$("#stats").html(""),this.reset();for(var t in this.gear)if(this.gear.hasOwnProperty(t))if(-1!==$.inArray(t,["rings","earrings"])){for(var e in this.gear[t])if(this.gear[t].hasOwnProperty(e)){var s=this.gear[t][e];if(0!==Object.keys(s.item).length){for(var i in s.item)s.item.hasOwnProperty(i)&&this.addStat(i,this.getItemStat(s,i));for(var a in s.item.item_effects)s.item.item_effects.hasOwnProperty(a)&&this.addStat(a,this.getItemStat(s,a,!0))}}}else if(Object.keys(this.gear[t].item).length>0){for(var n in this.gear[t].item)if(this.gear[t].item.hasOwnProperty(n)){var r=this.gear[t].item;this.addStat(n,this.getItemStat(this.gear[t],n))}for(var a in this.gear[t].item.item_effects)this.gear[t].item.item_effects.hasOwnProperty(a)&&this.addStat(a,this.getItemStat(this.gear[t],a,!0));switch(this.addToSets(this.gear[t].item.set,t),t){case"main-weapon":case"secondary-weapon":this.addStat("ap",this.getItemStat(this.gear[t],"ap_min")+"-"+this.getItemStat(this.gear[t],"ap_max"))}}this.calculateSetEffects();for(var h in this.stats)if(this.stats.hasOwnProperty(h)){var m=this.stats[h];if("special"!==h)$("#stats").append("<li><strong>"+m.title+":</strong> "+("ap"===h?m.min+" ~ "+m.max:m.total)+m.symbol+"</li>");else{$("#stats").append("<li><strong>"+m.title+":</strong></li>");for(var f=m.specials.length-1;f>=0;f--)$("#stats").append("<li>"+m.specials[f]+"</li>")}}}};